########################################################################
########################################################################
# Makefile for bootstrapping
########################################################################
########################################################################
CAT=cat
SED=sed
ECHO=echo
NODE=node
PRINTF=printf
########################################################################
SRCGEN1=./../../../../srcgen1
SRCGEN2=./../../../../srcgen2
XATSJSD=./../../../../srcgen2/xats2js
XATSPYD=./../../../../srcgen2/xats2py
########################################################################
S1XSHRD=\
$(SRCGEN1)/xats2js/srcgenx/xshared/runtime
S2XSHRD=\
$(SRCGEN2)/xats2js/srcgenx/xshared/runtime
########################################################################
########################################################################
#
# HX-2025-03-29:
# $(S1XSHRD) is used since the library code for
# ATS3-Xanadu/source2 is largely shared with ATS3-Xanadu/source1
#
########################################################################
#
# HX-2025-04-05:
# The [S1XSHRD] is used here as
# the code in [srcgen1/prelude] requires it.
#
all:: \
xats2py_pyemit00
xats2py_pyemit00: ; \
$(CAT) \
$(S2XSHRD)/xats2js_js1emit.js > $@_dats_out.js && \
$(CAT) \
$(S1XSHRD)/xats2js_prelude.js >> $@_dats_out.js && \
$(CAT) \
$(S1XSHRD)/xats2js_prelude_node.js >> $@_dats_out.js && \
$(CAT) \
$(S1XSHRD)/xats2js_xatslib_node.js >> $@_dats_out.js && \
$(SED) -E 's/jsx(...)tnm/js1\1tnm/g' \
$(SRCGEN2)/lib/lib2xatsopt.js | $(CAT) - >> $@_dats_out.js && \
$(SED) -E 's/jsx(...)tnm/js2\1tnm/g' \
$(XATSJSD)/srcgen1/lib/lib2xats2js.js | $(CAT) - >> $@_dats_out.js && \
$(SED) -E 's/jsx(...)tnm/js3\1tnm/g' \
$(XATSPYD)/srcgen1/lib/lib2xats2py.js | $(CAT) - >> $@_dats_out.js && \
$(NODE) \
  --stack-size=8192 $(XATS2JS_JSEMIT00) xats2py_pyemit00.dats >> $@_dats_out.js
#
all:: \
xats2py_pyemit01
xats2py_pyemit01: ; \
$(CAT) \
$(S2XSHRD)/xats2js_js1emit.js > $@_dats_out.js && \
$(CAT) \
$(S1XSHRD)/xats2js_prelude.js >> $@_dats_out.js && \
$(CAT) \
$(S1XSHRD)/xats2js_prelude_node.js >> $@_dats_out.js && \
$(CAT) \
$(S1XSHRD)/xats2js_xatslib_node.js >> $@_dats_out.js && \
$(SED) -E 's/jsx(...)tnm/js1\1tnm/g' \
$(SRCGEN2)/lib/lib2xatsopt.js | $(CAT) - >> $@_dats_out.js && \
$(SED) -E 's/jsx(...)tnm/js2\1tnm/g' \
$(XATSJSD)/srcgen1/lib/lib2xats2js.js | $(CAT) - >> $@_dats_out.js && \
$(SED) -E 's/jsx(...)tnm/js3\1tnm/g' \
$(XATSPYD)/srcgen1/lib/lib2xats2py.js | $(CAT) - >> $@_dats_out.js && \
$(NODE) \
  --stack-size=8192 $(XATS2JS_JSEMIT00) xats2py_pyemit01.dats >> $@_dats_out.js
#
xats2py_pyemit01_opt1: ; \
npx google-closure-compiler \
  -W QUIET --compilation_level SIMPLE \
  --js=xats2py_pyemit01_dats_out.js --js_output_file=xats2py_pyemit01_dats_opt1.js
#
########################################################################
########################################################################
clean:: ; rm -f *~
cleanall:: ; rm -f *~
########################################################################
cleanall:: ; rm -f xats2py_pyemit00_dats_out.js
cleanall:: ; rm -f xats2py_pyemit01_dats_out.js
cleanall:: ; rm -f xats2py_pyemit00_dats_opt1.js
cleanall:: ; rm -f xats2py_pyemit01_dats_opt1.js
########################################################################
########################################################################
XATS2JS_JSEMIT00=$(XATSJSD)/srcgen1/UTIL/xats2js_jsemit00_dats.js
XATS2JS_JSEMIT00=$(XATSJSD)/srcgen1/UTIL/xats2js_jsemit00_dats_out.js
########################################################################
########################################################################
